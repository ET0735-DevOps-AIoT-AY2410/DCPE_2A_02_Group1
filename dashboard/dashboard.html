<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Our Data</title>
    <link rel="stylesheet" href="styles.css">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(initializeCharts);

        let phChart, temperatureChart, humidityChart, lightChart, ecChart;
        let phData, temperatureData, humidityData, lightData, ecData;
        let options = {
            hAxis: {title: 'Time'},
            vAxis: {minValue: 0},
            legend: 'none',
            backgroundColor: '#f5f5f5',
            chartArea: {width: '80%', height: '70%'},
            tooltip: {isHtml: true},
            pointSize: 5,
            colors: ['#b3fcb6']
        };
        let updateInterval;

        function initializeCharts() {
            console.log("Initializing charts...");

            phData = new google.visualization.DataTable();
            phData.addColumn('string', 'Time');
            phData.addColumn('number', 'pH');
            phChart = new google.visualization.LineChart(document.getElementById('phChart'));

            temperatureData = new google.visualization.DataTable();
            temperatureData.addColumn('string', 'Time');
            temperatureData.addColumn('number', 'Temperature (Â°C)');
            temperatureChart = new google.visualization.LineChart(document.getElementById('temperatureChart'));

            humidityData = new google.visualization.DataTable();
            humidityData.addColumn('string', 'Time');
            humidityData.addColumn('number', 'Humidity (%)');
            humidityChart = new google.visualization.LineChart(document.getElementById('humidityChart'));

            lightData = new google.visualization.DataTable();
            lightData.addColumn('string', 'Time');
            lightData.addColumn('number', 'Light (lux)');
            lightChart = new google.visualization.LineChart(document.getElementById('lightChart'));

            ecData = new google.visualization.DataTable();
            ecData.addColumn('string', 'Time');
            ecData.addColumn('number', 'EC (mS/cm)');
            ecChart = new google.visualization.LineChart(document.getElementById('ecChart'));

            StartFetchingData();
        }

        function StartFetchingData() {
            console.log("Starting data fetch...");
            updateInterval = setInterval(FetchData, 1000);
        }

        function FetchData() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    console.log("Data fetched: ", data);
                    updateChart(phData, phChart, data.time, data.ph, 'pH Level');
                    updateChart(temperatureData, temperatureChart, data.time, data.temperature, 'Ambient Temperature');
                    updateChart(humidityData, humidityChart, data.time, data.humidity, 'Relative Humidity');
                    updateChart(lightData, lightChart, data.time, data.light, 'Ambient Light Intensity');
                    updateChart(ecData, ecChart, data.time, data.ec, 'EC Level');
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function updateChart(dataTable, chart, time, values, title) {
            console.log(`Updating chart: ${title}`);
            dataTable.removeRows(0, dataTable.getNumberOfRows());
            for (let i = 0; i < time.length; i++) {
                dataTable.addRow([time[i], values[i]]);
            }
            options.title = title;
            chart.draw(dataTable, options);
        }
    </script>
</head>
<body>
    <h1>This is the Dashboard</h1>
    <main>
        <div class="graph-container">
            <div class="graph" id="phChart"></div>
            <div class="graph" id="temperatureChart"></div>
            <div class="graph" id="humidityChart"></div>
            <div class="graph" id="lightChart"></div>
            <div class="graph" id="ecChart"></div>
        </div>
    </main>
</body>
</html>
